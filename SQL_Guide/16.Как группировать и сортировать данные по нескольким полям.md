# Как группировать и сортировать данные по нескольким полям

## Группировка по нескольким полям

В прошлых уроках вы объединяли данные в группы по полю. Но сделать это можно и сразу по нескольким полям.

Например, нужно узнать средний возраст клиентов, объединив их по зоне подключения и по размеру скидки. Сгруппируем данные по двум полям сразу: `connection_area` и `percent_of_discount`.

Скопировать код

SQL

```
SELECT connection_area,
       percent_of_discount,
       AVG(age) AS ave_age
FROM buyer 
GROUP BY connection_area, percent_of_discount; 
```

Произошло наложение — для каждого поля и для каждой категории скидки был рассчитан средний возраст клиента:

- для зоны «Футуристический цирк» — клиенты без скидки;
- для зоны «Футуристический цирк» — клиенты со скидкой 1%;
- для зоны «Футуристический цирк» — клиенты со скидкой 2% и т. д.

Порядок, в котором указаны поля после `GROUP BY`, влияет только на вид итоговой таблицы.

## Сортировка по нескольким полям

Сортировать по нескольким полям сложнее, чем группировать. При сортировке важен порядок полей, которые указывают после оператора `ORDER BY`.

В предыдущем запросе выделены три поля: зона подключения, процент скидки и средний возраст клиента. Оставим в таблице только зоны «Футуристический цирк» и «Робо-город».

Скопировать код

SQL

```
SELECT connection_area,
       percent_of_discount,
       AVG(age) AS ave_age
FROM buyer 
WHERE connection_area = 'Футуристический цирк' OR connection_area = 'Робо-город'
GROUP BY connection_area, percent_of_discount; 
```

|**connection_area**|**percent_of_discount**|**ave_age**|
|---|---|---|
|Робо-город|20|24.0000000000000000|
|Робо-город|5|18.5000000000000000|
|Футуристический цирк|5|44.0000000000000000|
|Футуристический цирк|4|27.2000000000000000|
|Робо-город|4|32.8571428571428571|
|Футуристический цирк|0|38.2000000000000000|
|Робо-город|1|29.6000000000000000|
|Робо-город|3|37.2500000000000000|
|Футуристический цирк|2|22.0000000000000000|
|Робо-город|0|21.0000000000000000|
|Робо-город|2|30.0000000000000000|
|Футуристический цирк|3|33.0000000000000000|
|Футуристический цирк|1|26.0000000000000000|

Такую таблицу сложно прочесть. Отсортируем данные по названию зоны в алфавитном порядке.

Скопировать код

SQL

```
SELECT connection_area,
       percent_of_discount,
       AVG(age) AS ave_age
FROM buyer 
WHERE connection_area = 'Футуристический цирк' OR connection_area = 'Робо-город'
GROUP BY connection_area, percent_of_discount
ORDER BY connection_area; 
```

|**connection_area**|**percent_of_discount**|**ave_age**|
|---|---|---|
|Робо-город|20|24.0000000000000000|
|Робо-город|5|18.5000000000000000|
|Робо-город|4|32.8571428571428571|
|Робо-город|1|29.6000000000000000|
|Робо-город|3|37.2500000000000000|
|Робо-город|0|21.0000000000000000|
|Робо-город|2|30.0000000000000000|
|Футуристический цирк|1|26.0000000000000000|
|Футуристический цирк|5|44.0000000000000000|
|Футуристический цирк|4|27.2000000000000000|
|Футуристический цирк|2|22.0000000000000000|
|Футуристический цирк|0|38.2000000000000000|
|Футуристический цирк|3|33.0000000000000000|

Уже лучше, но процент скидки оценить тяжело. Добавим его в условия сортировки, но в порядке убывания.

Скопировать код

SQL

```
SELECT connection_area,
       percent_of_discount,
       AVG(age) AS ave_age
FROM buyer 
WHERE connection_area = 'Футуристический цирк' OR connection_area = 'Робо-город'
GROUP BY connection_area, percent_of_discount
ORDER BY connection_area, percent_of_discount DESC; 
```

|**connection_area**|**percent_of_discount**|**ave_age**|
|---|---|---|
|Робо-город|20|24.0000000000000000|
|Робо-город|5|18.5000000000000000|
|Робо-город|4|32.8571428571428571|
|Робо-город|3|37.2500000000000000|
|Робо-город|2|30.0000000000000000|
|Робо-город|1|29.6000000000000000|
|Робо-город|0|21.0000000000000000|
|Футуристический цирк|5|44.0000000000000000|
|Футуристический цирк|4|27.2000000000000000|
|Футуристический цирк|3|33.0000000000000000|
|Футуристический цирк|2|22.0000000000000000|
|Футуристический цирк|1|26.0000000000000000|
|Футуристический цирк|0|38.2000000000000000|

Сортировки разных полей не конфликтуют между собой. Записи первого поля упорядочены в алфавитном порядке, записи второго — по убыванию. Ни одно правило сортировки не нарушает предыдущего.

❗ Порядок, в котором указаны поля после оператора `SELECT`, влияет только на расположение полей в таблице. Если после `SELECT` указать поля в другой последовательности, но сохранить порядок сортировки после `ORDER BY`, поля поменяются местами в таблице, но иерархия сортировки не изменится.
