# Как агрегировать данные

Большинство бизнес-задач невозможно решить без вычислений. Часто бизнесу нужно узнать: сколько всего было заказов? какая средняя стоимость заказа? какую максимальную прибыль получил сервис за всё время? На эти вопросы отвечают агрегирующие функции.

## Что такое агрегирующие функции

**Агрегирующие функции** позволяют проводить расчёты над группами данных и отображают результат в виде одной строки.

Основные агрегирующие функции в SQL:

- `SUM(поле)` возвращает сумму значений в поле;
- `AVG(поле)` находит среднее арифметическое для значений в поле;
- `MIN(поле)` возвращает минимальное значение в поле;
- `МАХ(поле)` возвращает максимальное значение в поле;
- `COUNT(поле)` выводит количество записей в поле.

Применим эти функции к полю `age` таблицы `buyer` и посмотрим на результат:

Скопировать кодSQL

```
SELECT SUM(age),
       AVG(age),
       MIN(age),
       MAX(age),
       COUNT(age)
FROM buyer; 
```

|**sum**|**avg**|**min**|**max**|**count**|
|---|---|---|---|---|
|5477|30.7696629213483146|17|100|178|

Функция `SUM` сложила все значения, которые были в поле `age`. Функция `AVG` подсчитала среднее арифметическое всех значений, а функции `MIN` и `MAX` нашли минимум и максимум. С функцией `COUNT` вы знакомы: она подсчитала все записи в поле.

Мы говорили про особенности деления целочисленных типов данных: в PostgreSQL такое деление проходит без остатка. Для агрегирующих функций это не важно — все операции проходят одинаково: и для целочисленных типов, и для дробных.

## Функция `DISTINCT`

Ещё одна важная функция — это `DISTINCT`. Она позволяет находить и рассчитывать показатели только по уникальным значениям.

Например, Света и Ира делали покупки в интернет-магазине. Света сделала 10 заказов, Ира — 15. Технически было совершено 25 заказов, и для каждого из них указан свой покупатель. Но уникальных покупателей — всего два. Так, имена Светы и Иры в заказах встречались 25 раз, но, исключив повторы с помощью функции `DISTINCT`, мы получим только двух покупательниц.

`DISTINCT` можно использовать как с другими агрегирующими функциями, так и без них.

Отобразим на экране, сколько всего уникальных значений в поле `percent_of_discount`:

Скопировать кодSQL

```
SELECT DISTINCT(percent_of_discount)
FROM buyer; 
```

|**percent_of_discount**|
|---|
|1|
|2|
|3|
|4|
|5|
|0|
|20|

Эти значения много раз встречаются в таблице, но уникальных — всего 7.

Теперь посмотрим, сколько всего пользователей в таблице `hotdog` и сколько — уникальных:

Скопировать кодSQL

```
SELECT COUNT(DISTINCT(bracelet_id)),
       COUNT(bracelet_id)
FROM hotdog; 
```

|**count**|**count**|
|---|---|
|130|870|

Уникальных пользователей 130, но они совершали покупки много раз, поэтому всего пользователей — 870.

## Агрегирующие функции с другими операциями

Агрегирующие функции можно комбинировать с условиями. Например, нужно рассчитать средний возраст клиентов-мужчин в таблице `buyer`. Отфильтруем таблицу по полю `gender` и применим функцию `AVG` к полю `age`.

Скопировать кодSQL

```
SELECT AVG(age)
FROM buyer
WHERE gender = 'Мужской'; 
```

|**avg**|
|---|
|31.4743589743589744|

Вот и ответ: функция подсчитала средний возраст клиентов мужского пола.

Агрегирующие функции можно применять и вместе с вычислениями. Усложним задачу с подсчётом доли скидки — рассчитаем для неё среднее. Запрос будет выглядеть так:

Скопировать кодSQL

```
SELECT AVG(percent_of_discont/100.0)
FROM buyer; 
```

| **avg**                |
| ---------------------- |
| 0.03382022471910112360 |
